name: traefik

# Tunnel-only mode override
# Usage: docker compose -f docker-compose.yml -f docker-compose.tunnel.yml up -d
#
# This override file:
# - Removes public port exposure (80, 443)
# - Removes CloudFlare API credential requirements
# - Configures Traefik to accept HTTP from cloudflared (TLS terminated at Cloudflare edge)
#
# Traffic flow: Internet -> Cloudflare Edge (TLS) -> cloudflared -> Traefik (HTTP) -> Services
#
# IMPORTANT: Existing service labels (entrypoints=websecure, tls=true) continue to work
# because we map the 'websecure' entrypoint to port 80 (HTTP from cloudflared).

services:

  traefik:
    # Remove CloudFlare API credentials (not needed - TLS at Cloudflare edge)
    environment:
      - CF_API_EMAIL=
      - CF_API_KEY=
    # Override ports: remove public 80/443, localhost-only dashboard
    ports:
      - "127.0.0.1:8080:8080"

  # Override init container with tunnel-only config (no ACME)
  traefik-init:
    command:
      - sh
      - -c
      - |
        cat > /config/traefik.yml << 'EOFCONFIG'
        api:
          dashboard: true
          insecure: false

        ping:
          entryPoint: traefik

        entryPoints:
          # In tunnel mode, cloudflared sends HTTP to port 80
          # We name it 'websecure' so existing service labels work unchanged
          websecure:
            address: ":80"
          traefik:
            address: ":8080"

        # No ACME/Let's Encrypt needed - TLS terminated at Cloudflare edge
        # Service labels with tls.certresolver are safely ignored

        providers:
          docker:
            exposedByDefault: false
            network: traefik_default

        log:
          level: INFO
          filePath: /etc/traefik/logs/traefik.log

        accessLog:
          filePath: /etc/traefik/logs/access.log
        EOFCONFIG
        echo "Traefik tunnel-only config generated at /config/traefik.yml"
        echo "Note: 'websecure' entrypoint now listens on :80 for HTTP from cloudflared"
        cat /config/traefik.yml
