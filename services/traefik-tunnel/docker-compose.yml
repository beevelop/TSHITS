name: traefik

# Traefik v3 reverse proxy - Tunnel Mode (Cloudflare Tunnel)
#
# This is a dedicated tunnel-only configuration with NO exposed ports.
# All traffic flows through Cloudflare Tunnel via cloudflared.
#
# Traffic flow: Internet -> Cloudflare Edge (TLS) -> cloudflared -> traefik:80 -> Services
#
# Usage:
#   docker compose -f oci://ghcr.io/beevelop/traefik-tunnel:latest --env-file .env up -d

services:

  traefik:
    image: traefik:${TRAEFIK_VERSION:-v3.6}
    container_name: traefik
    depends_on:
      traefik-init:
        condition: service_completed_successfully
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - traefik_config:/etc/traefik:ro
    # NO PORTS EXPOSED - Only accessible via Docker network
    # cloudflared connects to http://traefik:80 internally
    networks:
      - default
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "traefik", "healthcheck", "--ping"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    logging:
      driver: "json-file"
      options:
        max-size: "500k"
        max-file: "50"
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.dashboard.rule=Host(`${TRAEFIK_DOMAIN:-traefik.example.com}`) && (PathPrefix(`/api`) || PathPrefix(`/dashboard`))"
      - "traefik.http.routers.dashboard.entrypoints=websecure"
      - "traefik.http.routers.dashboard.service=api@internal"
      - "traefik.http.routers.dashboard.middlewares=dashboard-auth"
      - "traefik.http.middlewares.dashboard-auth.basicauth.users=${TRAEFIK_AUTH:-admin:$$apr1$$changeme}"

  traefik-init:
    image: alpine:3.23
    container_name: traefik-init
    volumes:
      - traefik_config:/config
    command:
      - sh
      - -c
      - |
        set -e
        
        echo "=== Traefik Tunnel Mode Configuration ==="
        echo "Generating configuration for Cloudflare Tunnel..."
        
        cat > /config/traefik.yml << 'EOFCONFIG'
        # Traefik v3 - Tunnel Mode
        # TLS terminated at Cloudflare edge, no ACME needed
        # cloudflared sends HTTP traffic to port 80
        
        api:
          dashboard: true
          insecure: false
        
        ping:
          entryPoint: websecure
        
        entryPoints:
          # In tunnel mode, cloudflared sends HTTP to port 80
          # Named 'websecure' so existing service labels work unchanged
          websecure:
            address: ":80"
        
        # No ACME/Let's Encrypt - TLS at Cloudflare edge
        # Service labels with tls.certresolver are safely ignored
        
        providers:
          docker:
            exposedByDefault: false
            network: traefik_default
        
        log:
          level: INFO
        
        accessLog: {}
        EOFCONFIG
        
        echo ""
        echo "=== Generated Configuration ==="
        cat /config/traefik.yml
        echo ""
        echo "Configuration saved. Traefik will listen on port 80 (internal only)."
        echo "Connect cloudflared to: http://traefik:80"
    restart: "no"
    logging:
      driver: "json-file"
      options:
        max-size: "500k"
        max-file: "50"

networks:
  default:
    name: traefik_default
    driver: bridge

volumes:
  traefik_config:
    name: ${COMPOSE_PROJECT_NAME:-traefik}_config
