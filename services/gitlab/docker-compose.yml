version: "3"
name: gitlab
services:
  database:
    image: sameersbn/postgresql:${POSTGRES_TAG}
    container_name: gitlab-postgres
    volumes:
      - postgres_data:/var/lib/postgresql
    environment:
      DB_NAME: ${DB_NAME}
      DB_USER: ${DB_USER}
      DB_PASS: ${DB_PASS}
      DB_EXTENSION: pg_trgm
    networks:
      - gitlab
    restart: unless-stopped
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U ${DB_USER:-gitlab} -d ${DB_NAME:-gitlabhq_production}" ]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s
    logging:
      driver: "json-file"
      options:
        max-size: "500k"
        max-file: "50"

  gitlab:
    image: sameersbn/gitlab:${GITLAB_VERSION}
    container_name: gitlab
    depends_on:
      - database
      - redis
    volumes:
      - gitlab_data:/home/git/data
    environment:
      # Database
      DB_ADAPTER: postgresql
      DB_HOST: database
      DB_PORT: "5432"
      DB_USER: ${DB_USER}
      DB_PASS: ${DB_PASS}
      DB_NAME: ${DB_NAME}
      # Redis
      REDIS_HOST: redis
      REDIS_PORT: "6379"
      # Timezone
      TZ: ${TZ:-Europe/Berlin}
      GITLAB_TIMEZONE: ${GITLAB_TIMEZONE:-Berlin}
      # Core
      GITLAB_HOST: ${SERVICE_DOMAIN}
      GITLAB_SSH_HOST: ${GITLAB_SSH_HOST:-${SERVICE_DOMAIN}}
      GITLAB_HTTPS: "true"
      GITLAB_HTTPS_HSTS_ENABLED: "false"
      # Secrets
      GITLAB_ROOT_PASSWORD: ${GITLAB_ROOT_PASSWORD}
      GITLAB_SECRETS_DB_KEY_BASE: ${GITLAB_SECRETS_DB_KEY_BASE}
      GITLAB_SECRETS_SECRET_KEY_BASE: ${GITLAB_SECRETS_SECRET_KEY_BASE}
      GITLAB_SECRETS_OTP_KEY_BASE: ${GITLAB_SECRETS_OTP_KEY_BASE}
      # Features
      GITLAB_NOTIFY_ON_BROKEN_BUILDS: ${GITLAB_NOTIFY_ON_BROKEN_BUILDS:-true}
      GITLAB_PROJECTS_SNIPPETS: ${GITLAB_PROJECTS_SNIPPETS:-true}
      # Backup
      GITLAB_BACKUPS: ${GITLAB_BACKUPS:-daily}
      GITLAB_BACKUP_TIME: ${GITLAB_BACKUP_TIME:-04:00}
      GITLAB_BACKUP_EXPIRY: ${GITLAB_BACKUP_EXPIRY:-172800}
      GITLAB_BACKUP_SKIP: ${GITLAB_BACKUP_SKIP:-builds,artifacts}
      # Email
      GITLAB_EMAIL: ${GITLAB_EMAIL:-noreply@example.com}
      GITLAB_EMAIL_DISPLAY_NAME: ${GITLAB_EMAIL_DISPLAY_NAME:-BeeCompose GitLab}
      # SMTP
      SMTP_ENABLED: ${SMTP_ENABLED:-false}
      SMTP_DOMAIN: ${SMTP_DOMAIN:-}
      SMTP_HOST: ${SMTP_HOST:-}
      SMTP_PORT: ${SMTP_PORT:-587}
      SMTP_USER: ${SMTP_USER:-}
      SMTP_PASS: ${SMTP_PASS:-}
      SMTP_TLS: ${SMTP_TLS:-true}
      SMTP_AUTHENTICATION: ${SMTP_AUTHENTICATION:-login}
      # IMAP
      IMAP_ENABLED: ${IMAP_ENABLED:-false}
      IMAP_HOST: ${IMAP_HOST:-}
      IMAP_PORT: ${IMAP_PORT:-}
      IMAP_USER: ${IMAP_USER:-}
      IMAP_PASS: ${IMAP_PASS:-}
      IMAP_SSL: ${IMAP_SSL:-}
      # Nginx
      NGINX_MAX_UPLOAD_SIZE: ${NGINX_MAX_UPLOAD_SIZE:-100m}
      # Unicorn
      GITLAB_UNICORN_MEMORY_MAX: ${GITLAB_UNICORN_MEMORY_MAX:-629145600}
    ports:
      - "0.0.0.0:${GIT_PORT:-2222}:22"
    networks:
      - traefik
      - gitlab
    restart: unless-stopped
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost/-/health" ]
      interval: 60s
      timeout: 30s
      retries: 5
      start_period: 300s
    logging:
      driver: "json-file"
      options:
        max-size: "500k"
        max-file: "50"
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.gitlab.rule=Host(`${SERVICE_DOMAIN}`)"
      - "traefik.http.routers.gitlab.entrypoints=websecure"
      - "traefik.http.routers.gitlab.tls=true"
      - "traefik.http.routers.gitlab.tls.certresolver=letsencrypt"
      - "traefik.http.services.gitlab.loadbalancer.server.port=80"
      - "traefik.docker.network=traefik_default"

  redis:
    image: redis:${REDIS_VERSION:-7-alpine}
    container_name: gitlab-redis
    volumes:
      - redis_data:/data
    networks:
      - gitlab
    command: redis-server --protected-mode no
    restart: unless-stopped
    healthcheck:
      test: [ "CMD", "redis-cli", "ping" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    logging:
      driver: "json-file"
      options:
        max-size: "500k"
        max-file: "50"

networks:
  gitlab:
  traefik:
    name: traefik_default
    external: true

volumes:
  postgres_data:
    name: ${COMPOSE_PROJECT_NAME:-gitlab}_postgres_data
  gitlab_data:
    name: ${COMPOSE_PROJECT_NAME:-gitlab}_app_data
  redis_data:
    name: ${COMPOSE_PROJECT_NAME:-gitlab}_redis_data
